{"version":3,"file":"upload-dragger2.mjs","sources":["../../../../../../packages/components/upload/src/upload-dragger.vue"],"sourcesContent":["<template>\n  <div\n    :class=\"[ns.b('dragger'), ns.is('dragover', dragover)]\"\n    @drop.prevent=\"onDrop\"\n    @dragover.prevent=\"onDragover\"\n    @dragleave.prevent=\"onDragleave\"\n  >\n    <slot />\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport { inject, ref } from 'vue'\nimport { useNamespace } from '@element-plus/hooks'\nimport { useFormDisabled } from '@element-plus/components/form'\nimport { throwError } from '@element-plus/utils/error'\nimport { flatten } from 'lodash-unified'\nimport { uploadContextKey } from './constants'\nimport { uploadDraggerEmits, uploadDraggerProps } from './upload-dragger'\n\nimport type { UploadRawFile } from './upload'\n\nconst COMPONENT_NAME = 'ElUploadDrag'\n\ndefineOptions({\n  name: COMPONENT_NAME,\n})\n\nconst props = defineProps(uploadDraggerProps)\nconst emit = defineEmits(uploadDraggerEmits)\n\nconst uploaderContext = inject(uploadContextKey)\nif (!uploaderContext) {\n  throwError(\n    COMPONENT_NAME,\n    'usage: <el-upload><el-upload-dragger /></el-upload>'\n  )\n}\n\nconst ns = useNamespace('upload')\nconst dragover = ref(false)\nconst disabled = useFormDisabled()\n\nconst getFile = (entry: FileSystemFileEntry): Promise<File> => {\n  return new Promise((resolve, reject) => entry.file(resolve, reject))\n}\n\nconst getAllFiles = async (\n  entry: FileSystemEntry\n): Promise<UploadRawFile[]> => {\n  try {\n    if (entry.isFile) {\n      const file = (await getFile(\n        entry as FileSystemFileEntry\n      )) as UploadRawFile\n      file.isDirectory = false\n      return [file]\n    }\n    if (entry.isDirectory) {\n      const dirReader = (entry as FileSystemDirectoryEntry).createReader()\n      const getEntries = (): Promise<FileSystemEntry[]> => {\n        return new Promise((resolve, reject) =>\n          dirReader.readEntries(resolve, reject)\n        )\n      }\n\n      const entries: FileSystemEntry[] = []\n      let readEntries = await getEntries()\n      /**\n       * In Chromium-based browsers, readEntries() will only return the first 100 FileSystemEntry instances.\n       * https://developer.mozilla.org/en-US/docs/Web/API/FileSystemDirectoryReader/readEntries#:~:text=In%20Chromium%2Dbased%20browsers%2C%20readEntries()%20will%20only%20return%20the%20first%20100%20FileSystemEntry%20instances.%20In%20order%20to%20obtain%20all%20of%20the%20instances%2C%20readEntries()%20must%20be%20called%20multiple%20times.\n       */\n      while (readEntries.length > 0) {\n        entries.push(...readEntries)\n        readEntries = await getEntries()\n      }\n\n      const filePromises = entries.map((entry) =>\n        getAllFiles(entry).catch(() => [])\n      )\n\n      const files = await Promise.all(filePromises)\n      return flatten(files)\n    }\n  } catch {\n    return []\n  }\n  return []\n}\n\nconst onDrop = async (e: DragEvent) => {\n  if (disabled.value) return\n  dragover.value = false\n\n  e.stopPropagation()\n\n  const files = Array.from(e.dataTransfer!.files) as UploadRawFile[]\n  const items = e.dataTransfer!.items || []\n\n  if (props.directory) {\n    const entries = Array.from(items)\n      .map((item) => item?.webkitGetAsEntry?.())\n      .filter((entry) => entry) as FileSystemEntry[]\n\n    const allFiles = await Promise.all(entries.map(getAllFiles))\n    emit('file', flatten(allFiles))\n    return\n  }\n\n  files.forEach((file, index) => {\n    const item = items[index]\n    const entry = item?.webkitGetAsEntry?.()\n    if (entry) {\n      file.isDirectory = entry.isDirectory\n    }\n  })\n  emit('file', files)\n}\n\nconst onDragover = () => {\n  if (!disabled.value) dragover.value = true\n}\n\nconst onDragleave = (e: DragEvent) => {\n  if (!(e.currentTarget as Element).contains(e.relatedTarget as Element))\n    dragover.value = false\n}\n</script>\n"],"names":["entry","_openBlock","_createElementBlock","_normalizeClass","_unref","_withModifiers","_renderSlot"],"mappings":"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"}