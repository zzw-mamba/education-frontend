{"version":3,"file":"current.mjs","sources":["../../../../../../../packages/components/table/src/store/current.ts"],"sourcesContent":["import { getCurrentInstance, ref, unref } from 'vue'\nimport { getRowIdentity } from '../util'\n\nimport type { Ref } from 'vue'\nimport type { DefaultRow, Table } from '../table/defaults'\nimport type { WatcherPropsData } from '.'\n\nfunction useCurrent<T extends DefaultRow>(watcherData: WatcherPropsData<T>) {\n  const instance = getCurrentInstance() as Table<T>\n  const _currentRowKey: Ref<string | null> = ref(null)\n  const currentRow: Ref<T | null> = ref(null)\n\n  const setCurrentRowKey = (key: string) => {\n    instance.store.assertRowKey()\n    _currentRowKey.value = key\n    setCurrentRowByKey(key)\n  }\n\n  const restoreCurrentRowKey = () => {\n    _currentRowKey.value = null\n  }\n\n  const setCurrentRowByKey = (key: string) => {\n    const { data, rowKey } = watcherData\n    const oldCurrentRow = currentRow.value\n    let _currentRow: T | null = null\n    if (rowKey.value) {\n      _currentRow =\n        (unref(data) || []).find(\n          (item) => getRowIdentity(item, rowKey.value) === key\n        ) ?? null\n    }\n    currentRow.value = _currentRow ?? null\n    instance.emit('current-change', currentRow.value, oldCurrentRow)\n  }\n\n  const updateCurrentRow = (_currentRow: T) => {\n    const oldCurrentRow = currentRow.value\n    if (_currentRow && _currentRow !== oldCurrentRow) {\n      currentRow.value = _currentRow\n      instance.emit('current-change', currentRow.value, oldCurrentRow)\n      return\n    }\n    if (!_currentRow && oldCurrentRow) {\n      currentRow.value = null\n      instance.emit('current-change', null, oldCurrentRow)\n    }\n  }\n\n  const updateCurrentRowData = () => {\n    const rowKey = watcherData.rowKey.value\n    // data 为 null 时，解构时的默认值会被忽略\n    const data = watcherData.data.value || []\n    const oldCurrentRow = currentRow.value\n    // 当 currentRow 不在 data 中时尝试更新数据\n    if (oldCurrentRow && !data.includes(oldCurrentRow)) {\n      if (rowKey) {\n        const currentRowKey = getRowIdentity(oldCurrentRow, rowKey)\n        setCurrentRowByKey(currentRowKey)\n      } else {\n        currentRow.value = null\n        instance.emit('current-change', null, oldCurrentRow)\n      }\n    } else if (_currentRowKey.value) {\n      // 把初始时下设置的 rowKey 转化成 rowData\n      setCurrentRowByKey(_currentRowKey.value)\n      restoreCurrentRowKey()\n    }\n  }\n\n  return {\n    setCurrentRowKey,\n    restoreCurrentRowKey,\n    setCurrentRowByKey,\n    updateCurrentRow,\n    updateCurrentRowData,\n    states: {\n      _currentRowKey,\n      currentRow,\n    },\n  }\n}\n\nexport default useCurrent\n"],"names":[],"mappings":"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"}