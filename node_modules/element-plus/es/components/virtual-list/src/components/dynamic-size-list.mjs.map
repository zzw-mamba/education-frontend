{"version":3,"file":"dynamic-size-list.mjs","sources":["../../../../../../../packages/components/virtual-list/src/components/dynamic-size-list.ts"],"sourcesContent":["import { throwError } from '@element-plus/utils'\nimport createList from '../builders/build-list'\nimport { isHorizontal } from '../utils'\nimport {\n  AUTO_ALIGNMENT,\n  CENTERED_ALIGNMENT,\n  DEFAULT_DYNAMIC_LIST_ITEM_SIZE,\n  END_ALIGNMENT,\n  SMART_ALIGNMENT,\n  START_ALIGNMENT,\n} from '../defaults'\n\nimport type { VirtualizedListProps } from '../props'\nimport type { ItemSize, ListCache, ListItem } from '../types'\n\ntype Props = VirtualizedListProps\n\nconst SCOPE = 'ElDynamicSizeList'\nconst getItemFromCache = (\n  props: Props,\n  index: number,\n  listCache: ListCache\n): ListItem => {\n  const { itemSize } = props\n  const { items, lastVisitedIndex } = listCache\n\n  if (index > lastVisitedIndex) {\n    let offset = 0\n    if (lastVisitedIndex >= 0) {\n      const item = items[lastVisitedIndex]\n      offset = item.offset + item.size\n    }\n\n    for (let i = lastVisitedIndex + 1; i <= index; i++) {\n      const size = (itemSize as ItemSize)(i)\n\n      items[i] = {\n        offset,\n        size,\n      }\n\n      offset += size\n    }\n\n    listCache.lastVisitedIndex = index\n  }\n\n  return items[index]\n}\n\nconst findItem = (props: Props, listCache: ListCache, offset: number) => {\n  const { items, lastVisitedIndex } = listCache\n\n  const lastVisitedOffset =\n    lastVisitedIndex > 0 ? items[lastVisitedIndex].offset : 0\n\n  if (lastVisitedOffset >= offset) {\n    return bs(props, listCache, 0, lastVisitedIndex, offset)\n  }\n  return es(props, listCache, Math.max(0, lastVisitedIndex), offset)\n}\n\n// bs stands for binary search which has approximately time complexity of O(Log n)\n// space complexity of O(1)\n// in this case we use it for search the offset of each item, since\n// the cached items' offset is monotonically increasing\nconst bs = (\n  props: Props,\n  listCache: ListCache,\n  low: number,\n  high: number,\n  offset: number\n) => {\n  while (low <= high) {\n    const mid = low + Math.floor((high - low) / 2)\n    const currentOffset = getItemFromCache(props, mid, listCache).offset\n\n    if (currentOffset === offset) {\n      return mid\n    } else if (currentOffset < offset) {\n      low = mid + 1\n    } else if (currentOffset > offset) {\n      high = mid - 1\n    }\n  }\n\n  return Math.max(0, low - 1)\n}\n\n// es stands for exponential search which has time complexity of O(Log n) and\n// space complexity of O(1) in the case of finding the boundary element.\n// the exponential indicator in this case is 2.\n// for more detail about exponential search click this link\n// https://www.freecodecamp.org/news/search-algorithms-exponential-search-explained/\n\nconst es = (\n  props: Props,\n  listCache: ListCache,\n  index: number,\n  offset: number\n) => {\n  const { total } = props\n  let exponent = 1\n\n  while (\n    index < total &&\n    getItemFromCache(props, index, listCache).offset < offset\n  ) {\n    index += exponent\n    exponent *= 2\n  }\n\n  return bs(\n    props,\n    listCache,\n    Math.floor(index / 2),\n    Math.min(index, total - 1),\n    offset\n  )\n}\n\nconst getEstimatedTotalSize = (\n  { total }: Props,\n  { items, estimatedItemSize, lastVisitedIndex }: ListCache\n) => {\n  let totalSizeOfMeasuredItems = 0\n\n  if (lastVisitedIndex >= total) {\n    lastVisitedIndex = total - 1\n  }\n\n  if (lastVisitedIndex >= 0) {\n    const item = items[lastVisitedIndex]\n    totalSizeOfMeasuredItems = item.offset + item.size\n  }\n\n  const numUnmeasuredItems = total - lastVisitedIndex - 1\n  const totalSizeOfUnmeasuredItems = numUnmeasuredItems * estimatedItemSize\n  return totalSizeOfMeasuredItems + totalSizeOfUnmeasuredItems\n}\n\nconst DynamicSizeList = createList({\n  name: 'ElDynamicSizeList',\n  getItemOffset: (props, index, listCache) =>\n    getItemFromCache(props, index, listCache).offset,\n\n  getItemSize: (_, index, { items }) => items[index].size,\n\n  getEstimatedTotalSize,\n\n  getOffset: (props, index, alignment, scrollOffset, listCache) => {\n    const { height, layout, width } = props\n\n    const size = (isHorizontal(layout) ? width : height) as number\n    const item = getItemFromCache(props, index, listCache)\n\n    const estimatedTotalSize = getEstimatedTotalSize(props, listCache)\n\n    const maxOffset = Math.max(\n      0,\n      Math.min(estimatedTotalSize - size, item.offset)\n    )\n    const minOffset = Math.max(0, item.offset - size + item.size)\n\n    if (alignment === SMART_ALIGNMENT) {\n      if (\n        scrollOffset >= minOffset - size &&\n        scrollOffset <= maxOffset + size\n      ) {\n        alignment = AUTO_ALIGNMENT\n      } else {\n        alignment = CENTERED_ALIGNMENT\n      }\n    }\n\n    switch (alignment) {\n      case START_ALIGNMENT: {\n        return maxOffset\n      }\n      case END_ALIGNMENT: {\n        return minOffset\n      }\n      case CENTERED_ALIGNMENT: {\n        return Math.round(minOffset + (maxOffset - minOffset) / 2)\n      }\n      case AUTO_ALIGNMENT:\n      default: {\n        if (scrollOffset >= minOffset && scrollOffset <= maxOffset) {\n          return scrollOffset\n        } else if (scrollOffset < minOffset) {\n          return minOffset\n        } else {\n          return maxOffset\n        }\n      }\n    }\n  },\n\n  getStartIndexForOffset: (props, offset, listCache) =>\n    findItem(props, listCache, offset),\n\n  getStopIndexForStartIndex: (props, startIndex, scrollOffset, listCache) => {\n    const { height, total, layout, width } = props\n\n    const size = (isHorizontal(layout) ? width : height) as number\n    const item = getItemFromCache(props, startIndex, listCache)\n    const maxOffset = scrollOffset + size\n\n    let offset = item.offset + item.size\n    let stopIndex = startIndex\n\n    while (stopIndex < total - 1 && offset < maxOffset) {\n      stopIndex++\n      offset += getItemFromCache(props, stopIndex, listCache).size\n    }\n\n    return stopIndex\n  },\n\n  initCache({ estimatedItemSize = DEFAULT_DYNAMIC_LIST_ITEM_SIZE }, instance) {\n    const cache = {\n      items: {},\n      estimatedItemSize,\n      lastVisitedIndex: -1,\n    } as ListCache\n\n    cache.clearCacheAfterIndex = (index: number, forceUpdate = true) => {\n      cache.lastVisitedIndex = Math.min(cache.lastVisitedIndex, index - 1)\n      instance.exposed?.getItemStyleCache(-1)\n\n      if (forceUpdate) {\n        instance.proxy?.$forceUpdate()\n      }\n    }\n\n    return cache\n  },\n\n  clearCache: false,\n\n  validateProps: ({ itemSize }) => {\n    if (process.env.NODE_ENV !== 'production') {\n      if (typeof itemSize !== 'function') {\n        throwError(\n          SCOPE,\n          `\n          itemSize is required as function, but the given value was ${typeof itemSize}\n        `\n        )\n      }\n    }\n  },\n})\n\nexport type DynamicSizeListInstance = InstanceType<typeof DynamicSizeList> &\n  unknown\nexport default DynamicSizeList\n"],"names":[],"mappings":"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"}