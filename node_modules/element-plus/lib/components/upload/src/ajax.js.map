{"version":3,"file":"ajax.js","sources":["../../../../../../packages/components/upload/src/ajax.ts"],"sourcesContent":["import { isNil } from 'lodash-unified'\nimport { isArray, throwError } from '@element-plus/utils'\n\nimport type {\n  UploadProgressEvent,\n  UploadRequestHandler,\n  UploadRequestOptions,\n} from './upload'\n\nconst SCOPE = 'ElUpload'\n\nexport class UploadAjaxError extends Error {\n  name = 'UploadAjaxError'\n  status: number\n  method: string\n  url: string\n\n  constructor(message: string, status: number, method: string, url: string) {\n    super(message)\n    this.status = status\n    this.method = method\n    this.url = url\n  }\n}\n\nfunction getError(\n  action: string,\n  option: UploadRequestOptions,\n  xhr: XMLHttpRequest\n) {\n  let msg: string\n  if (xhr.response) {\n    msg = `${xhr.response.error || xhr.response}`\n  } else if (xhr.responseText) {\n    msg = `${xhr.responseText}`\n  } else {\n    msg = `fail to ${option.method} ${action} ${xhr.status}`\n  }\n\n  return new UploadAjaxError(msg, xhr.status, option.method, action)\n}\n\nfunction getBody(xhr: XMLHttpRequest): XMLHttpRequestResponseType {\n  const text = xhr.responseText || xhr.response\n  if (!text) {\n    return text\n  }\n\n  try {\n    return JSON.parse(text)\n  } catch {\n    return text\n  }\n}\n\nexport const ajaxUpload: UploadRequestHandler = (option) => {\n  if (typeof XMLHttpRequest === 'undefined')\n    throwError(SCOPE, 'XMLHttpRequest is undefined')\n\n  const xhr = new XMLHttpRequest()\n  const action = option.action\n\n  if (xhr.upload) {\n    xhr.upload.addEventListener('progress', (evt) => {\n      const progressEvt = evt as UploadProgressEvent\n      progressEvt.percent = evt.total > 0 ? (evt.loaded / evt.total) * 100 : 0\n      option.onProgress(progressEvt)\n    })\n  }\n\n  const formData = new FormData()\n  if (option.data) {\n    for (const [key, value] of Object.entries(option.data)) {\n      if (isArray(value) && value.length) formData.append(key, ...value)\n      else formData.append(key, value)\n    }\n  }\n  formData.append(option.filename, option.file, option.file.name)\n\n  xhr.addEventListener('error', () => {\n    option.onError(getError(action, option, xhr))\n  })\n\n  xhr.addEventListener('load', () => {\n    if (xhr.status < 200 || xhr.status >= 300) {\n      return option.onError(getError(action, option, xhr))\n    }\n    option.onSuccess(getBody(xhr))\n  })\n\n  xhr.open(option.method, action, true)\n\n  if (option.withCredentials && 'withCredentials' in xhr) {\n    xhr.withCredentials = true\n  }\n\n  const headers = option.headers || {}\n  if (headers instanceof Headers) {\n    headers.forEach((value, key) => xhr.setRequestHeader(key, value))\n  } else {\n    for (const [key, value] of Object.entries(headers)) {\n      if (isNil(value)) continue\n      xhr.setRequestHeader(key, String(value))\n    }\n  }\n\n  xhr.send(formData)\n  return xhr\n}\n"],"names":["throwError","isArray","isNil"],"mappings":"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"}