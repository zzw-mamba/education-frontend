{"version":3,"file":"scrollbar.js","sources":["../../../../../../../packages/components/virtual-list/src/components/scrollbar.ts"],"sourcesContent":["import {\n  computed,\n  defineComponent,\n  h,\n  onBeforeUnmount,\n  reactive,\n  ref,\n  unref,\n  watch,\n  withModifiers,\n} from 'vue'\nimport { BAR_MAP } from '@element-plus/components/scrollbar'\nimport { cAF, rAF } from '@element-plus/utils'\nimport { useNamespace } from '@element-plus/hooks'\nimport { HORIZONTAL, SCROLLBAR_MIN_SIZE, ScrollbarDirKey } from '../defaults'\nimport { virtualizedScrollbarProps } from '../props'\nimport { renderThumbStyle } from '../utils'\n\nimport type { CSSProperties } from 'vue'\n\ninterface ScrollState {\n  isDragging: boolean\n  traveled: number\n  [key: string]: unknown\n}\n\nconst ScrollBar = defineComponent({\n  name: 'ElVirtualScrollBar',\n  props: virtualizedScrollbarProps,\n  emits: ['scroll', 'start-move', 'stop-move'],\n  setup(props, { emit }) {\n    const GAP = computed(() => props.startGap + props.endGap) // top 2 + bottom 2 | left 2 + right 2\n\n    const nsVirtualScrollbar = useNamespace('virtual-scrollbar')\n    const nsScrollbar = useNamespace('scrollbar')\n    // DOM refs\n    const trackRef = ref<HTMLElement>()\n    const thumbRef = ref<HTMLElement>()\n\n    // local variables\n    let frameHandle: null | number = null\n    let onselectstartStore: null | typeof document.onselectstart = null\n\n    // data\n    const state = reactive<ScrollState>({\n      isDragging: false,\n      traveled: 0,\n    })\n\n    const bar = computed(() => BAR_MAP[props.layout])\n\n    const trackSize = computed(() => props.clientSize! - unref(GAP))\n\n    const trackStyle = computed<CSSProperties>(() => ({\n      position: 'absolute',\n      width: `${\n        HORIZONTAL === props.layout ? trackSize.value : props.scrollbarSize\n      }px`,\n      height: `${\n        HORIZONTAL === props.layout ? props.scrollbarSize : trackSize.value\n      }px`,\n      [ScrollbarDirKey[props.layout]]: '2px',\n      right: '2px',\n      bottom: '2px',\n      borderRadius: '4px',\n    }))\n\n    const thumbSize = computed(() => {\n      const ratio = props.ratio!\n      if (ratio >= 100) {\n        return Number.POSITIVE_INFINITY\n      }\n\n      if (ratio >= 50) {\n        return (ratio * trackSize.value) / 100\n      }\n\n      const SCROLLBAR_MAX_SIZE = trackSize.value / 3\n      return Math.floor(\n        Math.min(\n          Math.max((ratio * trackSize.value) / 100, SCROLLBAR_MIN_SIZE),\n          SCROLLBAR_MAX_SIZE\n        )\n      )\n    })\n\n    const thumbStyle = computed<CSSProperties>(() => {\n      if (!Number.isFinite(thumbSize.value)) {\n        return {\n          display: 'none',\n        }\n      }\n\n      const thumb = `${thumbSize.value}px`\n\n      const style = renderThumbStyle(\n        {\n          bar: bar.value,\n          size: thumb,\n          move: state.traveled,\n        },\n        props.layout\n      )\n\n      return style\n    })\n\n    const totalSteps = computed(() =>\n      Math.ceil(props.clientSize! - thumbSize.value - unref(GAP))\n    )\n\n    const attachEvents = () => {\n      window.addEventListener('mousemove', onMouseMove)\n      window.addEventListener('mouseup', onMouseUp)\n\n      const thumbEl = unref(thumbRef)\n\n      if (!thumbEl) return\n\n      onselectstartStore = document.onselectstart\n      document.onselectstart = () => false\n\n      thumbEl.addEventListener('touchmove', onMouseMove, { passive: true })\n      thumbEl.addEventListener('touchend', onMouseUp)\n    }\n\n    const detachEvents = () => {\n      window.removeEventListener('mousemove', onMouseMove)\n      window.removeEventListener('mouseup', onMouseUp)\n\n      document.onselectstart = onselectstartStore\n      onselectstartStore = null\n\n      const thumbEl = unref(thumbRef)\n      if (!thumbEl) return\n\n      thumbEl.removeEventListener('touchmove', onMouseMove)\n      thumbEl.removeEventListener('touchend', onMouseUp)\n    }\n\n    const onThumbMouseDown = (e: Event | KeyboardEvent | MouseEvent) => {\n      e.stopImmediatePropagation()\n      if (\n        (e as KeyboardEvent).ctrlKey ||\n        [1, 2].includes((e as MouseEvent).button)\n      ) {\n        return\n      }\n\n      state.isDragging = true\n      state[bar.value.axis] =\n        (e.currentTarget as HTMLElement)[bar.value.offset] -\n        ((e as MouseEvent)[bar.value.client] -\n          (e.currentTarget as HTMLElement).getBoundingClientRect()[\n            bar.value.direction\n          ])\n\n      emit('start-move')\n      attachEvents()\n    }\n\n    const onMouseUp = () => {\n      state.isDragging = false\n      state[bar.value.axis] = 0\n      emit('stop-move')\n      detachEvents()\n    }\n\n    const onMouseMove = (e: MouseEvent | TouchEvent) => {\n      const { isDragging } = state\n      if (!isDragging) return\n      if (!thumbRef.value || !trackRef.value) return\n\n      const prevPage = state[bar.value.axis]\n      if (!prevPage) return\n\n      cAF(frameHandle!)\n      // using the current track's offset top/left - the current pointer's clientY/clientX\n      // to get the relative position of the pointer to the track.\n      const offset =\n        (trackRef.value.getBoundingClientRect()[bar.value.direction] -\n          (e as MouseEvent)[bar.value.client]) *\n        -1\n\n      // find where the thumb was clicked on.\n      const thumbClickPosition =\n        thumbRef.value[bar.value.offset] - (prevPage as number)\n      /**\n       *  +--------------+                                   +--------------+\n       *  |              -  <--------- thumb.offsetTop       |              |\n       *  |             |+|             <--+                 |              |\n       *  |              -                 |                 |              |\n       *  |   Content    |                 |                 |              |\n       *  |              |                 |                 |              |\n       *  |              |                 |                 |              |\n       *  |              |                 |                 |              -\n       *  |              |                 +-->              |             |+|\n       *  |              |                                   |              -\n       *  +--------------+                                   +--------------+\n       */\n\n      // using the current position - prev position to\n\n      const distance = offset - thumbClickPosition\n      // get how many steps in total.\n      // gap of 2 on top, 2 on bottom, in total 4.\n      // using totalSteps รท totalSize getting each step's size * distance to get the new\n      // scroll offset to scrollTo\n      frameHandle = rAF(() => {\n        state.traveled = Math.max(0, Math.min(distance, totalSteps.value))\n        emit('scroll', distance, totalSteps.value)\n      })\n    }\n\n    const clickTrackHandler = (e: MouseEvent) => {\n      const offset = Math.abs(\n        (e.target as HTMLElement).getBoundingClientRect()[bar.value.direction] -\n          e[bar.value.client]\n      )\n      const thumbHalf = thumbRef.value![bar.value.offset] / 2\n      const distance = offset - thumbHalf\n\n      state.traveled = Math.max(0, Math.min(distance, totalSteps.value))\n      emit('scroll', distance, totalSteps.value)\n    }\n\n    watch(\n      () => props.scrollFrom,\n      (v) => {\n        if (state.isDragging) return\n        /**\n         *  this is simply mapping the current scrollbar offset\n         *\n         *  formula 1:\n         *    v = scrollOffset / (estimatedTotalSize - clientSize)\n         *    traveled = v * (clientSize - thumbSize - GAP) --> v * totalSteps\n         *\n         *  formula 2:\n         *    traveled = (v * clientSize) / (clientSize / totalSteps) --> (v * clientSize) * (totalSteps / clientSize) --> v * totalSteps\n         */\n        state.traveled = Math.ceil(v! * totalSteps.value)\n      }\n    )\n\n    onBeforeUnmount(() => {\n      detachEvents()\n    })\n\n    return () => {\n      return h(\n        'div',\n        {\n          role: 'presentation',\n          ref: trackRef,\n          class: [\n            nsVirtualScrollbar.b(),\n            props.class,\n            (props.alwaysOn || state.isDragging) && 'always-on',\n          ],\n          style: trackStyle.value,\n          onMousedown: withModifiers(clickTrackHandler as (e: Event) => void, [\n            'stop',\n            'prevent',\n          ]),\n          onTouchstartPrevent: onThumbMouseDown,\n        },\n        h(\n          'div',\n          {\n            ref: thumbRef,\n            class: nsScrollbar.e('thumb'),\n            style: thumbStyle.value,\n            onMousedown: onThumbMouseDown,\n          },\n          []\n        )\n      )\n    }\n  },\n})\n\nexport default ScrollBar\n"],"names":["defineComponent","virtualizedScrollbarProps","computed","useNamespace","ref","reactive","BAR_MAP","unref","HORIZONTAL","ScrollbarDirKey","SCROLLBAR_MIN_SIZE","renderThumbStyle","cAF","rAF","watch","onBeforeUnmount","h","withModifiers"],"mappings":"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"}