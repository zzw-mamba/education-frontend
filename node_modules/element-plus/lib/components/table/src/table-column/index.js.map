{"version":3,"file":"index.js","sources":["../../../../../../../packages/components/table/src/table-column/index.ts"],"sourcesContent":["import {\n  Fragment,\n  computed,\n  defineComponent,\n  getCurrentInstance,\n  h,\n  onBeforeMount,\n  onBeforeUnmount,\n  onMounted,\n  ref,\n} from 'vue'\nimport ElCheckbox from '@element-plus/components/checkbox'\nimport { isArray, isString, isUndefined } from '@element-plus/utils'\nimport { cellStarts } from '../config'\nimport { compose, mergeOptions } from '../util'\nimport useWatcher from './watcher-helper'\nimport useRender from './render-helper'\nimport defaultProps from './defaults'\n\nimport type { VNode } from 'vue'\nimport type { TableColumn, TableColumnCtx } from './defaults'\nimport type { DefaultRow } from '../table/defaults'\n\nlet columnIdSeed = 1\n\n//TODO: when vue 3.3 we can set this component a generic: https://github.com/vuejs/core/pull/7963\nexport default defineComponent({\n  name: 'ElTableColumn',\n  components: {\n    ElCheckbox,\n  },\n  props: defaultProps,\n  setup(props, { slots }) {\n    const instance = getCurrentInstance() as TableColumn<DefaultRow>\n    const columnConfig = ref<Partial<TableColumnCtx<DefaultRow>>>({})\n    const owner = computed(() => {\n      let parent = instance.parent as any\n      while (parent && !parent.tableId) {\n        parent = parent.parent\n      }\n      return parent\n    })\n\n    const { registerNormalWatchers, registerComplexWatchers } = useWatcher(\n      owner,\n      props\n    )\n    const {\n      columnId,\n      isSubColumn,\n      realHeaderAlign,\n      columnOrTableParent,\n      setColumnWidth,\n      setColumnForcedProps,\n      setColumnRenders,\n      getPropsData,\n      getColumnElIndex,\n      realAlign,\n      updateColumnOrder,\n    } = useRender(props as unknown as TableColumnCtx<DefaultRow>, slots, owner)\n\n    const parent = columnOrTableParent.value\n    columnId.value = `${\n      ('tableId' in parent && parent.tableId) ||\n      ('columnId' in parent && parent.columnId)\n    }_column_${columnIdSeed++}`\n    onBeforeMount(() => {\n      isSubColumn.value = owner.value !== parent\n\n      const type = (props.type as keyof typeof cellStarts) || 'default'\n      const sortable = props.sortable === '' ? true : props.sortable\n      //The selection column should not be affected by `showOverflowTooltip`.\n      const showOverflowTooltip =\n        type === 'selection'\n          ? false\n          : isUndefined(props.showOverflowTooltip)\n            ? parent.props.showOverflowTooltip\n            : props.showOverflowTooltip\n      const tooltipFormatter = isUndefined(props.tooltipFormatter)\n        ? parent.props.tooltipFormatter\n        : props.tooltipFormatter\n      const defaults = {\n        ...cellStarts[type],\n        id: columnId.value,\n        type,\n        property: props.prop || props.property,\n        align: realAlign,\n        headerAlign: realHeaderAlign,\n        showOverflowTooltip,\n        tooltipFormatter,\n        // filter 相关属性\n        filterable: props.filters || props.filterMethod,\n        filteredValue: [],\n        filterPlacement: '',\n        filterClassName: '',\n        isColumnGroup: false,\n        isSubColumn: false,\n        filterOpened: false,\n        // sort 相关属性\n        sortable,\n        // index 列\n        index: props.index,\n        // <el-table-column key=\"xxx\" />\n        rawColumnKey: instance.vnode.key,\n      }\n\n      const basicProps = [\n        'columnKey',\n        'label',\n        'className',\n        'labelClassName',\n        'type',\n        'renderHeader',\n        'formatter',\n        'fixed',\n        'resizable',\n      ]\n      const sortProps = ['sortMethod', 'sortBy', 'sortOrders']\n      const selectProps = ['selectable', 'reserveSelection']\n      const filterProps = [\n        'filterMethod',\n        'filters',\n        'filterMultiple',\n        'filterOpened',\n        'filteredValue',\n        'filterPlacement',\n        'filterClassName',\n      ]\n\n      let column = getPropsData(basicProps, sortProps, selectProps, filterProps)\n\n      column = mergeOptions(defaults, column)\n      // 注意 compose 中函数执行的顺序是从右到左\n      const chains = compose(\n        setColumnRenders,\n        setColumnWidth,\n        setColumnForcedProps\n      )\n      column = chains(column) as unknown as TableColumnCtx<DefaultRow>\n      columnConfig.value = column\n\n      // 注册 watcher\n      registerNormalWatchers()\n      registerComplexWatchers()\n    })\n    onMounted(() => {\n      const parent = columnOrTableParent.value\n      const children = isSubColumn.value\n        ? parent.vnode.el?.children\n        : parent.refs.hiddenColumns?.children\n      const getColumnIndex = () =>\n        getColumnElIndex(children || [], instance.vnode.el)\n      columnConfig.value.getColumnIndex = getColumnIndex\n      const columnIndex = getColumnIndex()\n      columnIndex > -1 &&\n        owner.value.store.commit(\n          'insertColumn',\n          columnConfig.value,\n          isSubColumn.value\n            ? 'columnConfig' in parent && parent.columnConfig.value\n            : null,\n          updateColumnOrder\n        )\n    })\n    onBeforeUnmount(() => {\n      const getColumnIndex = columnConfig.value.getColumnIndex\n      const columnIndex = getColumnIndex ? getColumnIndex() : -1\n      columnIndex > -1 &&\n        owner.value.store.commit(\n          'removeColumn',\n          columnConfig.value,\n          isSubColumn.value\n            ? 'columnConfig' in parent && parent.columnConfig.value\n            : null,\n          updateColumnOrder\n        )\n    })\n    instance.columnId = columnId.value\n\n    instance.columnConfig = columnConfig as any\n    return\n  },\n  render() {\n    try {\n      const renderDefault = this.$slots.default?.({\n        row: {},\n        column: {},\n        $index: -1,\n      })\n      const children = []\n      if (isArray(renderDefault)) {\n        for (const childNode of renderDefault) {\n          if (\n            (childNode.type as any)?.name === 'ElTableColumn' ||\n            childNode.shapeFlag & 2\n          ) {\n            children.push(childNode)\n          } else if (\n            childNode.type === Fragment &&\n            isArray(childNode.children)\n          ) {\n            childNode.children.forEach((vnode) => {\n              // No rendering when vnode is dynamic slot or text\n              if (\n                (vnode as VNode)?.patchFlag !== 1024 &&\n                !isString((vnode as VNode)?.children)\n              ) {\n                children.push(vnode)\n              }\n            })\n          }\n        }\n      }\n      const vnode = h('div', children)\n      return vnode\n    } catch {\n      return h('div', [])\n    }\n  },\n})\n"],"names":["defineComponent","ElCheckbox","defaultProps","getCurrentInstance","ref","computed","parent","useWatcher","useRender","onBeforeMount","isUndefined","cellStarts","mergeOptions","compose","onMounted","onBeforeUnmount","isArray","Fragment","vnode","isString","h"],"mappings":";;;;;;;;;;;;;;AAuBA,IAAI,YAAe,GAAA,CAAA,CAAA;AAGnB,oBAAeA,mBAAgB,CAAA;AAAA,EAC7B,IAAM,EAAA,eAAA;AAAA,EACN,UAAY,EAAA;AAAA,gBACVC,gBAAA;AAAA,GACF;AAAA,EACA,KAAO,EAAAC,mBAAA;AAAA,EACP,KAAM,CAAA,KAAA,EAAO,EAAE,KAAA,EAAS,EAAA;AACtB,IAAA,MAAM,WAAWC,sBAAmB,EAAA,CAAA;AACpC,IAAM,MAAA,YAAA,GAAeC,OAAyC,CAAA,EAAE,CAAA,CAAA;AAChE,IAAM,MAAA,KAAA,GAAQC,aAAS,MAAM;AAC3B,MAAA,IAAIC,UAAS,QAAS,CAAA,MAAA,CAAA;AACtB,MAAOA,OAAAA,OAAAA,IAAU,CAACA,OAAAA,CAAO,OAAS,EAAA;AAChC,QAAAA,UAASA,OAAO,CAAA,MAAA,CAAA;AAAA,OAClB;AACA,MAAOA,OAAAA,OAAAA,CAAAA;AAAA,KACR,CAAA,CAAA;AAED,IAAM,MAAA,EAAE,sBAAwB,EAAA,uBAAA,EAA4B,GAAAC,wBAAA;AAAA,MAC1D,KAAA;AAAA,MACA,KAAA;AAAA,KACF,CAAA;AACA,IAAM,MAAA;AAAA,MACJ,QAAA;AAAA,MACA,WAAA;AAAA,MACA,eAAA;AAAA,MACA,mBAAA;AAAA,MACA,cAAA;AAAA,MACA,oBAAA;AAAA,MACA,gBAAA;AAAA,MACA,YAAA;AAAA,MACA,gBAAA;AAAA,MACA,SAAA;AAAA,MACA,iBAAA;AAAA,KACE,GAAAC,uBAAA,CAAU,KAAgD,EAAA,KAAA,EAAO,KAAK,CAAA,CAAA;AAE1E,IAAA,MAAM,SAAS,mBAAoB,CAAA,KAAA,CAAA;AACnC,IAAS,QAAA,CAAA,KAAA,GAAQ,GACd,SAAa,IAAA,MAAA,IAAU,OAAO,OAC9B,IAAA,UAAA,IAAc,MAAU,IAAA,MAAA,CAAO,QACvB,CAAA,QAAA,EAAA,YAAA,EAAA,CAAA,CAAA,CAAA;AACX,IAAAC,iBAAA,CAAc,MAAM;AAClB,MAAY,WAAA,CAAA,KAAA,GAAQ,MAAM,KAAU,KAAA,MAAA,CAAA;AAEpC,MAAM,MAAA,IAAA,GAAQ,MAAM,IAAoC,IAAA,SAAA,CAAA;AACxD,MAAA,MAAM,QAAW,GAAA,KAAA,CAAM,QAAa,KAAA,EAAA,GAAK,OAAO,KAAM,CAAA,QAAA,CAAA;AAEtD,MAAM,MAAA,mBAAA,GACJ,IAAS,KAAA,WAAA,GACL,KACA,GAAAC,iBAAA,CAAY,KAAM,CAAA,mBAAmB,CACnC,GAAA,MAAA,CAAO,KAAM,CAAA,mBAAA,GACb,KAAM,CAAA,mBAAA,CAAA;AACd,MAAM,MAAA,gBAAA,GAAmBA,kBAAY,KAAM,CAAA,gBAAgB,IACvD,MAAO,CAAA,KAAA,CAAM,mBACb,KAAM,CAAA,gBAAA,CAAA;AACV,MAAA,MAAM,QAAW,GAAA;AAAA,QACf,GAAGC,iBAAW,CAAA,IAAA,CAAA;AAAA,QACd,IAAI,QAAS,CAAA,KAAA;AAAA,QACb,IAAA;AAAA,QACA,QAAA,EAAU,KAAM,CAAA,IAAA,IAAQ,KAAM,CAAA,QAAA;AAAA,QAC9B,KAAO,EAAA,SAAA;AAAA,QACP,WAAa,EAAA,eAAA;AAAA,QACb,mBAAA;AAAA,QACA,gBAAA;AAAA,QAEA,UAAA,EAAY,KAAM,CAAA,OAAA,IAAW,KAAM,CAAA,YAAA;AAAA,QACnC,eAAe,EAAC;AAAA,QAChB,eAAiB,EAAA,EAAA;AAAA,QACjB,eAAiB,EAAA,EAAA;AAAA,QACjB,aAAe,EAAA,KAAA;AAAA,QACf,WAAa,EAAA,KAAA;AAAA,QACb,YAAc,EAAA,KAAA;AAAA,QAEd,QAAA;AAAA,QAEA,OAAO,KAAM,CAAA,KAAA;AAAA,QAEb,YAAA,EAAc,SAAS,KAAM,CAAA,GAAA;AAAA,OAC/B,CAAA;AAEA,MAAA,MAAM,UAAa,GAAA;AAAA,QACjB,WAAA;AAAA,QACA,OAAA;AAAA,QACA,WAAA;AAAA,QACA,gBAAA;AAAA,QACA,MAAA;AAAA,QACA,cAAA;AAAA,QACA,WAAA;AAAA,QACA,OAAA;AAAA,QACA,WAAA;AAAA,OACF,CAAA;AACA,MAAA,MAAM,SAAY,GAAA,CAAC,YAAc,EAAA,QAAA,EAAU,YAAY,CAAA,CAAA;AACvD,MAAM,MAAA,WAAA,GAAc,CAAC,YAAA,EAAc,kBAAkB,CAAA,CAAA;AACrD,MAAA,MAAM,WAAc,GAAA;AAAA,QAClB,cAAA;AAAA,QACA,SAAA;AAAA,QACA,gBAAA;AAAA,QACA,cAAA;AAAA,QACA,eAAA;AAAA,QACA,iBAAA;AAAA,QACA,iBAAA;AAAA,OACF,CAAA;AAEA,MAAA,IAAI,MAAS,GAAA,YAAA,CAAa,UAAY,EAAA,SAAA,EAAW,aAAa,WAAW,CAAA,CAAA;AAEzE,MAAS,MAAA,GAAAC,iBAAA,CAAa,UAAU,MAAM,CAAA,CAAA;AAEtC,MAAA,MAAM,MAAS,GAAAC,YAAA;AAAA,QACb,gBAAA;AAAA,QACA,cAAA;AAAA,QACA,oBAAA;AAAA,OACF,CAAA;AACA,MAAA,MAAA,GAAS,OAAO,MAAM,CAAA,CAAA;AACtB,MAAA,YAAA,CAAa,KAAQ,GAAA,MAAA,CAAA;AAGrB,MAAuB,sBAAA,EAAA,CAAA;AACvB,MAAwB,uBAAA,EAAA,CAAA;AAAA,KACzB,CAAA,CAAA;AACD,IAAAC,aAAA,CAAU,MAAM;AAjJpB,MAAA,IAAA,EAAA,EAAA,EAAA,CAAA;AAkJM,MAAA,MAAMR,UAAS,mBAAoB,CAAA,KAAA,CAAA;AACnC,MAAA,MAAM,QAAW,GAAA,WAAA,CAAY,KACzB,GAAA,CAAA,EAAA,GAAAA,OAAO,CAAA,KAAA,CAAM,EAAb,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAiB,QACjB,GAAA,CAAA,EAAA,GAAAA,OAAO,CAAA,IAAA,CAAK,kBAAZ,IAA2B,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,QAAA,CAAA;AAC/B,MAAM,MAAA,cAAA,GAAiB,MACrB,gBAAiB,CAAA,QAAA,IAAY,EAAI,EAAA,QAAA,CAAS,MAAM,EAAE,CAAA,CAAA;AACpD,MAAA,YAAA,CAAa,MAAM,cAAiB,GAAA,cAAA,CAAA;AACpC,MAAA,MAAM,cAAc,cAAe,EAAA,CAAA;AACnC,MAAc,WAAA,GAAA,CAAA,CAAA,IACZ,KAAM,CAAA,KAAA,CAAM,KAAM,CAAA,MAAA;AAAA,QAChB,cAAA;AAAA,QACA,YAAa,CAAA,KAAA;AAAA,QACb,YAAY,KACR,GAAA,cAAA,IAAkBA,OAAUA,IAAAA,OAAAA,CAAO,aAAa,KAChD,GAAA,IAAA;AAAA,QACJ,iBAAA;AAAA,OACF,CAAA;AAAA,KACH,CAAA,CAAA;AACD,IAAAS,mBAAA,CAAgB,MAAM;AACpB,MAAM,MAAA,cAAA,GAAiB,aAAa,KAAM,CAAA,cAAA,CAAA;AAC1C,MAAM,MAAA,WAAA,GAAc,cAAiB,GAAA,cAAA,EAAmB,GAAA,CAAA,CAAA,CAAA;AACxD,MAAc,WAAA,GAAA,CAAA,CAAA,IACZ,KAAM,CAAA,KAAA,CAAM,KAAM,CAAA,MAAA;AAAA,QAChB,cAAA;AAAA,QACA,YAAa,CAAA,KAAA;AAAA,QACb,YAAY,KACR,GAAA,cAAA,IAAkB,MAAU,IAAA,MAAA,CAAO,aAAa,KAChD,GAAA,IAAA;AAAA,QACJ,iBAAA;AAAA,OACF,CAAA;AAAA,KACH,CAAA,CAAA;AACD,IAAA,QAAA,CAAS,WAAW,QAAS,CAAA,KAAA,CAAA;AAE7B,IAAA,QAAA,CAAS,YAAe,GAAA,YAAA,CAAA;AACxB,IAAA,OAAA;AAAA,GACF;AAAA,EACA,MAAS,GAAA;AAtLX,IAAA,IAAA,EAAA,EAAA,EAAA,EAAA,EAAA,CAAA;AAuLI,IAAI,IAAA;AACF,MAAA,MAAM,aAAgB,GAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,IAAA,CAAK,MAAO,EAAA,OAAA,KAAZ,IAAsB,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,IAAA,CAAA,EAAA,EAAA;AAAA,QAC1C,KAAK,EAAC;AAAA,QACN,QAAQ,EAAC;AAAA,QACT,MAAQ,EAAA,CAAA,CAAA;AAAA,OACV,CAAA,CAAA;AACA,MAAA,MAAM,WAAW,EAAC,CAAA;AAClB,MAAI,IAAAC,cAAA,CAAQ,aAAa,CAAG,EAAA;AAC1B,QAAA,KAAA,MAAW,aAAa,aAAe,EAAA;AACrC,UAAA,IAAA,CAAA,CACG,eAAU,IAAV,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAwB,UAAS,eAClC,IAAA,SAAA,CAAU,YAAY,CACtB,EAAA;AACA,YAAA,QAAA,CAAS,KAAK,SAAS,CAAA,CAAA;AAAA,qBAEvB,SAAU,CAAA,IAAA,KAASC,gBACnBD,cAAQ,CAAA,SAAA,CAAU,QAAQ,CAC1B,EAAA;AACA,YAAU,SAAA,CAAA,QAAA,CAAS,OAAQ,CAAA,CAACE,MAAU,KAAA;AAEpC,cACGA,IAAAA,CAAAA,MAAAA,IAAA,IAAAA,GAAAA,KAAAA,CAAAA,GAAAA,MAAAA,CAAiB,SAAc,MAAA,IAAA,IAChC,CAACC,eAAA,CAAUD,MAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAAA,MAAiB,CAAA,QAAQ,CACpC,EAAA;AACA,gBAAA,QAAA,CAAS,KAAKA,MAAK,CAAA,CAAA;AAAA,eACrB;AAAA,aACD,CAAA,CAAA;AAAA,WACH;AAAA,SACF;AAAA,OACF;AACA,MAAM,MAAA,KAAA,GAAQE,KAAE,CAAA,KAAA,EAAO,QAAQ,CAAA,CAAA;AAC/B,MAAO,OAAA,KAAA,CAAA;AAAA,aACD,CAAN,EAAA;AACA,MAAO,OAAAA,KAAA,CAAE,KAAO,EAAA,EAAE,CAAA,CAAA;AAAA,KACpB;AAAA,GACF;AACF,CAAC,CAAA;;;;"}